name: Build and Deploy

on:
  push:
    branches: [ master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set lowercase image name
        run: |
          echo "IMAGE_NAME_LOWER=$(echo ${{ env.IMAGE_NAME }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV
      
      - name: Log in to Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LOWER }}:latest
          build-args: APP_VERSION=${{ github.sha }}
      
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          timeout: 60s
          command_timeout: 10m
          script: |
            IMAGE="ghcr.io/abbiehooper/cicddemo:latest"
            
            # Clean up any leftover containers
            docker stop cicd-demo-new 2>/dev/null || true
            docker rm cicd-demo-new 2>/dev/null || true
            
            # Pull new image
            docker pull $IMAGE
            
            # Start new container on port 8081 for testing
            docker run -d \
              --name cicd-demo-new \
              -p 8081:8080 \
              -e APP_VERSION=${{ github.sha }} \
              $IMAGE
            
            # Wait for health check
            echo "Waiting for health check..."
            for i in {1..30}; do
              if curl -f http://localhost:8081/health > /dev/null 2>&1; then
                echo "✅ New container is healthy!"
                
                # Stop and remove old container
                docker stop cicd-demo 2>/dev/null || true
                docker rm cicd-demo 2>/dev/null || true
                
                # Remove the test container
                docker stop cicd-demo-new
                docker rm cicd-demo-new
                
                # Start the final container on port 8080
                docker run -d \
                  --name cicd-demo \
                  --restart unless-stopped \
                  -p 8080:8080 \
                  -e APP_VERSION=${{ github.sha }} \
                  $IMAGE
                
                # Verify it started
                sleep 3
                if docker ps | grep -q cicd-demo; then
                  echo "🎉 Deployment complete!"
                  exit 0
                else
                  echo "❌ Final container failed to start"
                  exit 1
                fi
              fi
              echo "Attempt $i: Not ready yet..."
              sleep 2
            done
            
            echo "❌ Health check failed, rolling back"
            docker stop cicd-demo-new
            docker rm cicd-demo-new
            exit 1